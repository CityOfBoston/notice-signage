<template>
  <div id='app' class='app'>
    <div class='header'>
      <h1>City Clerk Postings</h1>
      <LastUpdated></LastUpdated>
    </div>
    <div class='container'>
      <div class="main">
        <div class='columns'>
          <Notice :notice="column_one" :column="one"></Notice>
          <Notice :notice="column_two" :column="two"></Notice>
          <Notice :notice="column_three" :column="three"></Notice>
        </div>
        <div class="countdown">Next page in <span class="cursor">:</span>{{time}}</div>
      </div>
      <div class='column sidebar'>
        <NoticeList :notices="notices"></NoticeList>
      </div>
    </div>
  </div>
</template>

<script>
import Notice from './components/Notice'
import NoticeList from './components/NoticeList'
import LastUpdated from './components/LastUpdated'

export default {
  name: 'app',

  components: {
    NoticeList,
    LastUpdated,
    Notice
  },

  data: function () {
    return {
      time: null,
      clock: false,
      seconds: 5,
      initialized: false,
      notices: [],
      notice_counter: 0,
      one: 'column_one',
      two: 'column_two',
      three: 'column_three',
      column_one: {},
      column_two: {},
      column_three: {}
    }
  },

  methods: {
    addColumnNotice: function (column) {
      let self = this

      if (!self.notices[self.notice_counter]) {
        self.notice_counter = 0
      }

      self[column] = self.notices[self.notice_counter]

      self.notice_counter++
    },

    initialized: function () {
      // Setup the first columns
      this.$el.classList.add('is-ready')

      // Set to initialized
      this.initialized = true

      // Start the clock
      this.startTheClock()

      // Add notices to columns
      this.addColumnNotice('column_one')
      this.addColumnNotice('column_two')
      this.addColumnNotice('column_three')

      // Listen for the switch notice event
      window.kyle.$on('switch_notice', function (data) {
        console.log(data)
      })
    },

    startTheClock: function () {
      if (this.clock !== true) {
        // Setup the timer
        var seconds = this.seconds
        var time = seconds
        var self = this

        // Start the counter
        setInterval(function () {
          // Set the time
          self.time = time

          if (time === 0) {
            time = seconds
            window.kyle.$emit('change_page')
          } else {
            time--
          }
        }, 1000)

        // The clock is running
        this.clock = true
      } else {
        console.log('Clock is running. OMG!')
      }
    },

    updateData: function () {
      this.$http.get('http://spyglass.dd:8083/api/v1/public-notices').then((response) => {
        // set data on vm
        this.notices = response.body

        // Reschedule the data update
        setTimeout(this.updateData, 2000)

        // If not initialized, then initialize
        if (this.initialized !== true) {
          window.kyle.$emit('initialized')
        }
      }, (response) => {
        setTimeout(this.updateData, 2000)
      })
    }
  },

  created: function () {
    this.updateData()
    window.kyle.$on('initialized', this.initialized)
  }
}
</script>

<style scoped>
.app {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  flex-direction: column;
}

.header {
  background: #000000;
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 1em;
}

h1 {
  margin: 0;
  color: #ffffff;
}

.container {
  flex: 1;
  display: flex;
  flex-direction: row;
}

.main {
  flex: 0.65;
  padding: 1rem;
  display: flex;
  flex-direction: column;
}

.columns {
  display: flex;
  flex-direction: row;
}

.countdown {
  padding-top: 0.875rem;
}

.sidebar {
  flex: 0.35;
  background-color: #ffffff;
  padding: 0;
}

.column:not(:first-child).sidebar {
  margin-left: 0;
}
</style>
